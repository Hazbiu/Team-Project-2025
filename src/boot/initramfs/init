#!/bin/sh
mount -t proc none /proc
mount -t sysfs none /sys
echo "Booting from initramfs..."

# Initialize simple device manager (mdev)
echo /sbin/mdev > /proc/sys/kernel/hotplug
mdev -s

# Give devices a short moment to settle
sleep 2

echo "Available block devices:"
ls /dev

# Try both /dev/vda1 and /dev/vda (raw image)
if [ -b /dev/vda1 ]; then
    DEV=/dev/vda1
elif [ -b /dev/vda ]; then
    DEV=/dev/vda
else
    echo "Error: No /dev/vda or /dev/vda1 found!"
    ls -l /dev
    exec /bin/sh
fi

echo "Mounting root filesystem from $DEV..."
if ! mount -t ext4 "$DEV" /newroot; then
    echo "Mount failed for $DEV â€” trying read/write and debug:"
    mount -t ext4 -o rw "$DEV" /newroot || {
        echo "Still failed. Listing block devices:"
        lsblk || ls /dev
        exec /bin/sh
    }
fi

echo "Switching to real root filesystem..."
exec switch_root /newroot /sbin/init || {
    echo "switch_root failed!"
    exec /bin/sh
}

