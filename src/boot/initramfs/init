#!/bin/sh
mount -t proc none /proc
mount -t sysfs none /sys
echo "Booting from initramfs..."

# Initialize simple device manager (mdev)
echo /sbin/mdev > /proc/sys/kernel/hotplug
mdev -s

# Parse root device from kernel cmdline
ROOTDEV=$(grep -o 'root=[^ ]*' /proc/cmdline | cut -d= -f2)

if [ -z "$ROOTDEV" ]; then
    echo "Error: No root= argument found in /proc/cmdline!"
    echo "cmdline was: $(cat /proc/cmdline)"
    exec /bin/sh
fi

echo "Waiting for root device: $ROOTDEV ..."
for i in $(seq 1 10); do
    if [ -b "$ROOTDEV" ]; then
        echo "Found root device: $ROOTDEV"
        break
    fi
    sleep 1
    mdev -s
done

if [ ! -b "$ROOTDEV" ]; then
    echo "Error: Root device $ROOTDEV not found!"
    ls -l /dev
    exec /bin/sh
fi

echo "Mounting root filesystem from $ROOTDEV ..."
if ! mount -t ext4 "$ROOTDEV" /newroot; then
    echo "Mount failed for $ROOTDEV â€” trying read/write and debug:"
    mount -t ext4 -o rw "$ROOTDEV" /newroot || {
        echo "Still failed. Listing block devices:"
        lsblk || ls /dev
        exec /bin/sh
    }
fi

echo "Switching to real root filesystem..."
exec switch_root /newroot /sbin/init || {
    echo "switch_root failed!"
    exec /bin/sh
}
